#!/usr/bin/env ruby

require 'sqlite3'
require 'json'
require 'yaml'

db = SQLite3::Database.new("run-data/data.db")

rows = db.execute <<-SQL
  create table if not exists runs (
    id varchar,
    title varchar,
    description varchar,
    distance int,
    duration int,
    moving_duration int,
    type varchar,
    elevation int,
    date date,
    map varchar,
    PRIMARY KEY (id)
  );
SQL

db.transaction
Dir['run-data/processed/*.json'].each do |filename|
  data = JSON.parse(File.read(filename))
  db.execute "insert or ignore into runs values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )", data.values_at(*%w(id title description distance duration moving_duration type elevation date map))
end
db.commit

require 'pp'
stats = {
  'yearly_stats' => {}
}
db.execute("SELECT strftime('%Y', date), SUM(distance) / 1000.0, SUM(elevation), SUM(duration) / 60.0 / 60.0 FROM runs GROUP BY 1 ORDER BY 1").map do |row|
  stats['yearly_stats'][row[0].to_i] = {
    'distance' => row[1],
    'elevation' => row[2]
  }
end
File.write("data/stats/running.yml", stats.to_yaml)
# pp(db.execute "SELECT * FROM runs WHERE id IN (SELECT id FROM (SELECT id, MAX(distance) FROM runs))")
